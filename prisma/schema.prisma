generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 用户核心信息表，存储登录所需的基本字段
model User {
  /// 唯一主键字符串，由业务层生成后写入
  id            String                @id @default(cuid())
  /// 用户的展示名称，可选
  name          String?
  /// 用户邮箱，可选但确保全局唯一
  email         String?               @unique
  /// 邮箱验证时间戳，允许为空
  emailVerified DateTime?
  /// 头像链接，可选
  image         String?
  /// 密码哈希，可选，用于本地登录方案
  passwordHash  String?
  /// 记录创建时间，默认当前时间
  createdAt     DateTime              @default(now())
  /// 更新时间，需要由业务自行更新
  updatedAt     DateTime              @default(now()) @updatedAt
  accounts      Account[]
  messages      ConversationMessage[]
  sessions      Session[]
  profile       UserProfile?
  /// 吐槽对战回合记录
  roastBattleRounds RoastBattleRound[]

  @@map("user")
}

/// 第三方 OAuth / 本地账号绑定表，关联 User
model Account {
  id                String   @id @default(cuid())
  /// 所属用户 ID
  userId            String
  /// 账户类型（例如 oauth）
  type              String
  /// 提供商名称（如 google）
  provider          String
  /// 第三方账号 ID
  providerAccountId String
  /// 刷新令牌
  refresh_token     String?
  /// 访问令牌
  access_token      String?
  /// 过期时间（秒）
  expires_at        Int?
  /// 令牌类型
  token_type        String?
  /// 授权范围
  scope             String?
  /// ID 令牌
  id_token          String?
  /// 会话状态
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId], map: "account_provider_provider_account_id_key")
  @@index([userId], map: "account_user_id_idx")
  @@map("account")
}

/// 会话表，用于管理当前登录会话
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique(map: "session_session_token_key")
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "session_user_id_idx")
  @@map("session")
}

/// 验证令牌表，用于短信/邮箱验证码等场景
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_token")
}

/// 会话中的消息详情，包含文本或语音参数
model ConversationMessage {
  id              String                  @id
  conversationId  String
  /// 消息角色，仅允许 SYSTEM/USER/ASSISTANT/TOOL
  role            ConversationMessageRole
  /// 文本内容，非语音时必填
  content         String?
  /// 是否为语音消息
  isVoice         Boolean                 @default(false)
  /// 语音时长（毫秒）
  voiceDurationMs Int?
  /// 归属用户 ID，用于关联发送者
  userId          String
  createdAt       DateTime                @default(now())
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId], map: "conversation_message_conversation_id_idx")
  @@index([conversationId, createdAt], map: "conversation_message_conversation_id_created_at_idx")
  @@index([userId], map: "conversation_message_user_id_idx")
  @@map("conversation_message")
}

/// 用户每日主题线程表，用于记录用户在某个业务日期的文本主题与评分
model UserDailyThread {
  /// 自增主键
  id        BigInt   @id @default(autoincrement())
  /// 归属用户 ID（对应 user.id 的字符串主键）
  userId    String   @map("user_id")
  /// 业务日期，仅保留日期部分（示例：2026-01-05）
  day       DateTime @db.Date
  /// 主题文本，最长 120 字符（业务要求 ≤ 30 字）
  text      String   @db.VarChar(120)
  /// 评分，0-100 之间的整数
  score     Int      @db.SmallInt
  /// 创建时间
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  /// 更新时间（自动更新）
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([userId, day, text], map: "uq_user_day_text")
  @@index([userId, day(sort: Desc)], map: "idx_user_day")
  @@index([userId, day(sort: Desc), score(sort: Desc)], map: "idx_user_day_score")
  @@map("user_daily_threads")
}

/// 用户画像表，存储用户的结构化 profile 数据
model UserProfile {
  /// 自增主键
  id        BigInt   @id @default(autoincrement())
  /// 归属用户 ID（唯一）
  userId    String   @unique @map("user_id")
  /// 画像 JSON 数据
  profile   Json
  /// 创建时间
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  /// 更新时间（自动更新）
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

/// 吐槽对战回合记录
model RoastBattleRound {
  id         BigInt   @id @default(autoincrement())

  /// 归属用户 ID（对应 user.id）
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// 本轮得分 0-100
  score      Int      @db.SmallInt

  /// 是否胜利
  isWin      Boolean  @map("is_win")

  /// 本轮用户吐槽次数
  roastCount Int      @default(0) @map("roast_count")

  /// 本轮开始时间
  startedAt  DateTime @map("started_at") @db.Timestamptz(6)

  /// 本轮胜利时间（没赢就为空）
  wonAt      DateTime? @map("won_at") @db.Timestamptz(6)

  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId, startedAt(sort: Desc)], map: "idx_roast_battle_rounds_user_time")
  @@index([userId, isWin], map: "idx_roast_battle_rounds_user_win")
  @@map("roast_battle_rounds")
}

/// 会话消息角色枚举，用于区分系统/用户/助手/工具来源
enum ConversationMessageRole {
  SYSTEM
  USER
  ASSISTANT
  TOOL
}
